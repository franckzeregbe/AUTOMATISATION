<style>
  .section-heading { display:flex; align-items:center; gap:10px; }
  .section-heading .icon-svg { width:28px; height:28px; transition: transform 0.18s ease; }
  .section-heading:hover .icon-svg { transform: scale(1.12); }
  
  @keyframes wave { 0%, 100% { transform: rotate(0deg); } 25% { transform: rotate(20deg); } 75% { transform: rotate(-20deg); } }
  @keyframes bounce { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-10px); } }
  @keyframes glow { 0%, 100% { box-shadow: 0 0 20px rgba(106,17,203,0.5); } 50% { box-shadow: 0 0 40px rgba(106,17,203,0.8); } }
  
  .agent-avatar { 
    width: 120px; height: 120px; 
    background: linear-gradient(135deg, #6a11cb, #2575fc); 
    border-radius: 50%; 
    display: flex; 
    align-items: center; 
    justify-content: center; 
    font-size: 60px; 
    margin: 20px auto;
    animation: bounce 2s infinite, glow 2s infinite;
    overflow: hidden;
  }
  .agent-avatar img {
    width: 100%;
    height: 100%;
    object-fit: cover;
  }
  
  .greeting-box {
    background: linear-gradient(135deg, rgba(106,17,203,0.2), rgba(37,117,252,0.2));
    padding: 20px;
    border-radius: 12px;
    margin: 20px 0;
    border-left: 4px solid #6a11cb;
    animation: fadeInUp 0.8s;
  }
  
  .input-container { display: flex; gap: 10px; margin: 20px 0; flex-wrap: wrap; }
  
  #priereInput { 
    flex: 1;
    min-width: 200px;
    padding: 12px 16px;
    border: 2px solid rgba(255,255,255,0.15);
    border-radius: 8px;
    background: rgba(255,255,255,0.08);
    color: white;
    font-size: 14px;
    transition: all 0.3s ease;
  }
  #priereInput::placeholder { color: rgba(255,255,255,0.6); }
  #priereInput:focus { 
    outline: none;
    border-color: #6a11cb;
    background: rgba(255,255,255,0.12);
    box-shadow: 0 0 12px rgba(106,17,203,0.3);
  }
  
  button { 
    padding: 12px 24px;
    background: linear-gradient(135deg, #6a11cb 0%, #2575fc 100%);
    color: white;
    border: none;
    border-radius: 8px;
    font-weight: bold;
    cursor: pointer;
    transition: transform 0.2s, box-shadow 0.2s;
  }
  button:hover { 
    transform: translateY(-2px);
    box-shadow: 0 8px 20px rgba(106, 17, 203, 0.4);
  }
  
  .voice-btn {
    background: linear-gradient(135deg, #ff5252, #ff7043);
    width: 50px;
    height: 50px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 24px;
    position: relative;
  }
  
  .voice-btn.recording {
    animation: pulse 1s infinite;
    background: linear-gradient(135deg, #f44336, #e91e63);
  }
  
  .audio-message {
    background: rgba(255,255,255,0.08);
    padding: 12px;
    border-radius: 8px;
    margin: 10px 0;
    display: flex;
    align-items: center;
    gap: 10px;
  }
  
  .audio-controls {
    display: flex;
    gap: 8px;
    margin-top: 10px;
  }
  
  @keyframes pulse { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.1); } }
  
  #reponse {
    margin-top: 20px;
    padding: 16px;
    background: rgba(255,255,255,0.08);
    border-left: 4px solid #6a11cb;
    border-radius: 8px;
    display: none;
  }
  #reponse.active { display: block; }
  #reponse p { margin: 8px 0; }
  #reponse em { font-style: italic; color: #ffeb3b; }
  #reponse .signature { 
    font-size: 11px; 
    color: rgba(255,255,255,0.5); 
    margin-top: 12px; 
    padding-top: 10px; 
    border-top: 1px solid rgba(255,255,255,0.1);
  }
  #reponse .compassion { 
    color: #ffeb3b; 
    font-weight: 500;
    margin-bottom: 12px;
  }
</style>

<h2 class="section-heading"><span>ü§ñ Agent JOHN - Intelligence Spirituelle</span></h2>

<div id="greetingBox" class="greeting-box">
  <div class="agent-avatar">
    <img src="https://api.dicebear.com/7.x/avataaars/svg?seed=John&backgroundColor=6a11cb,2575fc&style=circle" alt="Agent JOHN" onerror="this.parentElement.innerHTML='ü§ñ'">
  </div>
  <h3 style="text-align: center; color: #ffeb3b; margin: 10px 0;">Bonjour ! Je suis JOHN, votre compagnon spirituel</h3>
  <p style="text-align: center; line-height: 1.6;">
    Je suis une intelligence artificielle con√ßue pour vous accompagner dans votre marche avec Dieu. 
    Je comprends vos pr√©occupations, je prie avec vous et je vous guide avec la Parole de Dieu. 
    Partagez votre c≈ìur avec moi, par texte ou par voix. üôè
  </p>
  <p style="text-align: center; margin-top: 15px;">
    <button onclick="startConversation()">‚ú® Commencer</button>
  </p>
</div>

<div id="conversationBox" style="display: none;">
  <div style="background: rgba(255,255,255,0.05); padding: 15px; border-radius: 10px; margin-bottom: 15px;">
    <p style="margin: 0 0 5px 0; font-weight: bold;">‚úçÔ∏è Partagez votre pr√©occupation avec moi :</p>
    <p style="margin: 0; font-size: 12px; opacity: 0.7;">ü§ñ Je suis une IA spirituelle - √âcrivez ou parlez au micro (üé§)</p>
  </div>
  <div class="input-container">
    <input type="text" id="priereInput" placeholder="Ex: Seigneur J√©sus, gu√©ris mon enfant" onkeypress="if(event.key==='Enter') envoyerPriere()">
    <button onclick="envoyerPriere()">üì§ Envoyer</button>
    <button class="voice-btn" id="voiceBtn" onclick="toggleVoice()" title="Reconnaissance vocale">üé§</button>
  </div>
  <p id="voiceStatus" style="color: #ff5252; display: none; margin: 10px 0; font-weight: bold;"></p>
  <div id="audioPreview" style="display: none;"></div>
  <div id="reponse"></div>
</div>

<script>
let recognition = null;
let isRecording = false;
let mediaRecorder = null;
let audioChunks = [];
let audioBlob = null;
let recordingStream = null;

function startConversation() {
  document.getElementById('greetingBox').style.display = 'none';
  document.getElementById('conversationBox').style.display = 'block';
  localStorage.setItem('agentGreeted', 'true');
}

if (localStorage.getItem('agentGreeted') === 'true') {
  startConversation();
}

async function toggleVoice() {
  if (!('webkitSpeechRecognition' in window) && !('SpeechRecognition' in window)) {
    alert('‚ùå Reconnaissance vocale non support√©e. Utilisez Chrome ou Edge.');
    return;
  }

  if (isRecording) {
    stopVoiceRecognition();
  } else {
    try {
      await navigator.mediaDevices.getUserMedia({ audio: true });
      startVoiceRecognition();
    } catch (error) {
      alert('‚ùå Acc√®s au microphone refus√©.');
    }
  }
}

function startVoiceRecognition() {
  const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
  recognition = new SpeechRecognition();
  recognition.lang = 'fr-FR';
  recognition.continuous = false;
  recognition.interimResults = false;

  recognition.onstart = () => {
    isRecording = true;
    document.getElementById('voiceBtn').classList.add('recording');
    document.getElementById('voiceStatus').textContent = 'üé§ Parlez maintenant...';
    document.getElementById('voiceStatus').style.display = 'block';
  };

  recognition.onresult = (event) => {
    const transcript = event.results[0][0].transcript;
    document.getElementById('priereInput').value = transcript;
    stopVoiceRecognition();
  };

  recognition.onerror = (event) => {
    let message = '‚ùå Erreur';
    if (event.error === 'not-allowed') message = '‚ùå Microphone refus√©';
    else if (event.error === 'no-speech') message = '‚ö†Ô∏è Aucune parole d√©tect√©e';
    alert(message);
    stopVoiceRecognition();
  };

  recognition.onend = () => stopVoiceRecognition();
  recognition.start();
}

function stopVoiceRecognition() {
  if (recognition) recognition.stop();
  isRecording = false;
  document.getElementById('voiceBtn').classList.remove('recording');
  document.getElementById('voiceStatus').style.display = 'none';
}

// Audio Recording Functions
async function toggleRecording() {
  if (mediaRecorder && mediaRecorder.state === 'recording') {
    stopAudioRecording();
  } else {
    try {
      await startAudioRecording();
    } catch (error) {
      alert('‚ùå Impossible d\'acc√©der au microphone.');
    }
  }
}

async function startAudioRecording() {
  audioChunks = [];
  recordingStream = await navigator.mediaDevices.getUserMedia({ audio: true });
  mediaRecorder = new MediaRecorder(recordingStream);

  mediaRecorder.ondataavailable = (event) => {
    audioChunks.push(event.data);
  };

  mediaRecorder.onstop = () => {
    audioBlob = new Blob(audioChunks, { type: 'audio/webm' });
    displayAudioPreview();
    recordingStream.getTracks().forEach(track => track.stop());
  };

  mediaRecorder.start();
  document.getElementById('recordBtn').classList.add('recording');
  document.getElementById('voiceStatus').textContent = 'üî¥ Enregistrement audio en cours... (Cliquez pour arr√™ter)';
  document.getElementById('voiceStatus').style.display = 'block';
}

function stopAudioRecording() {
  if (mediaRecorder && mediaRecorder.state === 'recording') {
    mediaRecorder.stop();
    document.getElementById('recordBtn').classList.remove('recording');
    document.getElementById('voiceStatus').style.display = 'none';
  }
}

function displayAudioPreview() {
  const preview = document.getElementById('audioPreview');
  const audioUrl = URL.createObjectURL(audioBlob);
  
  preview.innerHTML = `
    <div class="audio-message">
      <span>üéµ Message audio enregistr√©</span>
      <audio controls src="${audioUrl}" style="flex: 1; max-width: 300px;"></audio>
      <div class="audio-controls">
        <button onclick="sendAudioMessage()" style="padding: 8px 16px; font-size: 13px;">üì§ Envoyer</button>
        <button onclick="cancelAudio()" style="padding: 8px 16px; font-size: 13px; background: #f44336;">‚ùå Annuler</button>
      </div>
    </div>
  `;
  preview.style.display = 'block';
}

function sendAudioMessage() {
  if (!audioBlob) return;
  
  // Simuler l'envoi (dans une vraie app, vous enverriez √† un serveur)
  const userName = currentUser ? currentUser.fullname.split(' ')[0] : 'ami(e)';
  const reponseDiv = document.getElementById('reponse');
  reponseDiv.innerHTML = `
    <p class="compassion">üôè ${userName}, j'ai re√ßu et analys√© votre message audio.</p>
    <p><em>"L'√âternel entend quand je crie √† lui." - Psaume 4:3</em></p>
    <p>Votre pri√®re a √©t√© entendue. En tant qu'agent IA, je vous assure que Dieu conna√Æt les d√©sirs de votre c≈ìur et Il agit en votre faveur. Continuez √† Lui faire confiance.</p>
    <p style="margin-top: 15px; padding: 12px; background: rgba(106,17,203,0.2); border-radius: 8px; font-size: 14px;">
      üí° Je suis une intelligence artificielle d√©di√©e √† votre accompagnement spirituel. N'h√©sitez pas √† me parler √† nouveau.
    </p>
    <p class="signature">‚ú® JOHN - Agent IA ‚Ä¢ J√©sus revient bient√¥t</p>
  `;
  reponseDiv.classList.add('active');
  
  cancelAudio();
  alert('‚úÖ Message audio envoy√© avec succ√®s !');
}

function cancelAudio() {
  document.getElementById('audioPreview').style.display = 'none';
  document.getElementById('audioPreview').innerHTML = '';
  audioBlob = null;
  audioChunks = [];
}

function envoyerPriere() {
  // Cacher l'aper√ßu audio si pr√©sent
  if (audioBlob) cancelAudio();
  const input = document.getElementById("priereInput").value.trim().toLowerCase();

  const reponses = {
    guerison: [
      "J√©sus est le m√©decin des m√©decins, Il gu√©rit toute maladie (Matthieu 8:17).",
      "Par les meurtrissures de J√©sus, tu es gu√©ri (√âsa√Øe 53:5).",
      "J√©sus a gu√©ri les malades et Il agit encore aujourd'hui."
    ],
    famille: [
      "J√©sus est le fondement de ta maison (Josu√© 24:15).",
      "Crois au Seigneur J√©sus, et tu seras sauv√©, toi et ta famille (Actes 16:31).",
      "J√©sus prot√®ge et b√©nit ta famille."
    ],
    foi: [
      "J√©sus est l'auteur et le consommateur de ta foi (H√©breux 12:2).",
      "Celui qui croit en J√©sus vivra, m√™me s'il meurt (Jean 11:25).",
      "J√©sus dit : Si tu peux croire, tout est possible (Marc 9:23)."
    ],
    combat: [
      "J√©sus a vaincu le diable √† la croix (Colossiens 2:15).",
      "Rev√™ts-toi de l'armure de Dieu en J√©sus-Christ (√âph√©siens 6:11).",
      "J√©sus est ton bouclier et ta victoire."
    ],
    paix: [
      "J√©sus est le Prince de la paix (√âsa√Øe 9:6).",
      "Ma paix je vous donne, dit J√©sus (Jean 14:27).",
      "J√©sus calme la temp√™te dans ton c≈ìur."
    ]
  };

  let theme = "foi";
  if (input.includes("gu√©ri") || input.includes("maladie") || input.includes("sant√©")) theme = "guerison";
  else if (input.includes("famille") || input.includes("enfant") || input.includes("mariage")) theme = "famille";
  else if (input.includes("combat") || input.includes("ennemi") || input.includes("lutte")) theme = "combat";
  else if (input.includes("paix") || input.includes("calme") || input.includes("repos")) theme = "paix";

  const paroles = reponses[theme];
  const parole = paroles[Math.floor(Math.random() * paroles.length)];
  
  const guides = {
    guerison: [
      `Ce verset rappelle que la gu√©rison est possible et que Dieu voit ta douleur. <br>Garde confiance aujourd'hui; fais un petit pas concret vers le soin (repos, m√©decin, pri√®re).`,
      `Ce passage affirme que la souffrance n'est pas ton dernier mot. <br>Porte cette esp√©rance dans ton c≈ìur et accepte l'aide autour de toi.`
    ],
    famille: [
      `Ce verset t'encourage √† placer J√©sus au centre de ta maison. <br>Recherche la paix en pratiquant le pardon et en priant ensemble.`,
      `La parole renforce les liens familiaux lorsqu'on s'appuie sur la foi. <br>Parle avec douceur, aime intentionnellement et demande la b√©n√©diction de Dieu.`
    ],
    foi: [
      `Ce verset te rappelle que la foi soutient les jours difficiles. <br>Tiens-toi ferme dans la pri√®re et avance par petits pas de confiance.`,
      `La foi ouvre des chemins l√† o√π tu vois des barri√®res. <br>Confie tes peurs √† Dieu et agis avec esp√©rance aujourd'hui.`
    ],
    combat: [
      `Ce passage te rappelle que tu n'es pas seul dans la bataille. <br>Rev√™ts-toi de courage, prie pour force, et appuie-toi sur les promesses de Dieu.`,
      `La victoire est d√©j√† proclam√©e par la croix; tiens-toi ferme. <br>Affirme la parole, refuse la peur et cherche le soutien des fr√®res et s≈ìurs.`
    ],
    paix: [
      `Ce verset apporte une paix qui d√©passe la compr√©hension. <br>Respire profond√©ment, confie tes inqui√©tudes √† J√©sus et accueille sa paix.`,
      `La paix est un don; laisse-la habiter ton c≈ìur aujourd'hui. <br>Prends un moment pour te recueillir et permettre √† Dieu de calmer ta temp√™te.`
    ]
  };

  function makeMessage(theme, verse) {
    const arr = guides[theme] || guides['foi'];
    const guide = arr[Math.floor(Math.random() * arr.length)];
    const userName = currentUser ? currentUser.fullname.split(' ')[0] : 'ami(e)';
    return `
      <p class="compassion">üôè ${userName}, j'ai entendu ta pr√©occupation et je comprends ce que tu traverses.</p>
      <p><em>${verse}</em></p>
      <p>${guide}</p>
      <p style="margin-top: 15px; padding: 12px; background: rgba(106,17,203,0.2); border-radius: 8px; font-size: 14px;">
        üí° <strong>En tant qu'IA spirituelle</strong>, je suis ici pour t'encourager avec la Parole de Dieu. 
        N'h√©site pas √† partager d'autres pr√©occupations, je suis toujours √† l'√©coute.
      </p>
      <p class="signature">‚ú® JOHN - Agent IA ‚Ä¢ J√©sus revient bient√¥t</p>
    `;
  }

  if (input) {
    const reponseDiv = document.getElementById("reponse");
    reponseDiv.innerHTML = makeMessage(theme, parole);
    reponseDiv.classList.add("active");
    document.getElementById("priereInput").value = '';
  } else {
    alert("Veuillez entrer une pri√®re.");
  }
}
</script>
