<style>
  .section-heading { display:flex; align-items:center; gap:10px; }
  .section-heading .icon-svg { width:28px; height:28px; transition: transform 0.18s ease; }
  .section-heading:hover .icon-svg { transform: scale(1.12); }
  .bible-book-item { transition: transform 0.12s ease, background 0.12s ease; }
  .bible-book-item:hover { transform: translateX(6px); background: rgba(255,255,255,0.06); }
</style>
<h2 class="section-heading"><svg class="icon-svg" aria-hidden="true"><use href="#icon-bible"></use></svg> <span>Bible</span></h2>
<p>Consulter les versets de Gen√®se √† Apocalypse</p>

<style>
  .bible-container { display: flex; gap: 20px; max-height: 70vh; }
  .bible-books { width: 220px; overflow-y: auto; background: rgba(255,255,255,0.05); padding: 15px; border-radius: 12px; }
  .bible-book-item { padding: 12px; margin: 8px 0; background: rgba(255,255,255,0.08); cursor: pointer; border-radius: 8px; color: white; transition: all 0.2s; border-left: 3px solid transparent; }
  .bible-book-item:hover { background: rgba(106,17,203,0.3); transform: translateX(5px); }
  .bible-book-item.active { background: linear-gradient(90deg, rgba(106,17,203,0.5), rgba(37,117,252,0.3)); color: white; border-left-color: #ffeb3b; font-weight: bold; }
  .bible-viewer { flex: 1; overflow-y: auto; padding: 20px; background: rgba(255,255,255,0.08); border-radius: 12px; font-size: 15px; line-height: 1.8; }
  .bible-verse { background: rgba(255,255,255,0.05); padding: 12px; margin: 10px 0; border-radius: 8px; border-left: 3px solid #6a11cb; }
  .bible-verse strong { color: #ffeb3b; background: rgba(0,0,0,0.3); padding: 4px 8px; border-radius: 4px; margin-right: 8px; font-weight: bold; }
  @media (max-width: 768px) {
    .bible-container { flex-direction: column; max-height: none; }
    .bible-books { width: 100%; max-height: 200px; }
    .bible-viewer { padding: 15px; font-size: 14px; }
  }
</style>

<!-- S√©lecteur de version -->
<div style="margin: 15px 0; padding: 15px; background: rgba(106,17,203,0.2); border-radius: 10px;">
  <label style="font-size: 16px; font-weight: bold; margin-right: 10px;">üìñ Version:</label>
  <select id="bibleVersionSelect" onchange="changeBibleVersion()" style="padding: 10px 20px; border-radius: 8px; background: rgba(255,255,255,0.15); color: white; border: 2px solid rgba(255,255,255,0.3); font-size: 15px; font-weight: bold; cursor: pointer;">
    <option value="kjv">King James Version (KJV)</option>
    <option value="lsg">Louis Segond 1910 (LSG)</option>
    <option value="darby">Darby (FR)</option>
  </select>
  <div style="margin-top: 10px; font-size: 13px; opacity: 0.9;">
    <span id="offlineStatus">üì∂ Mode en ligne</span> ‚Ä¢ Les chapitres consult√©s sont automatiquement disponibles hors ligne
  </div>
</div>

<div id="audioControls" style="display: none; margin: 20px 0; padding: 15px; background: rgba(255,255,255,0.08); border-radius: 10px;">
  <div style="display: flex; align-items: center; gap: 10px; flex-wrap: wrap;">
    <button id="playBtn" onclick="toggleAudio()" style="padding: 10px 20px; background: linear-gradient(135deg, #6a11cb, #2575fc); border: none; border-radius: 8px; color: white; cursor: pointer; font-size: 14px;">
      üîä Lire le chapitre
    </button>
    <button id="pauseBtn" onclick="pauseAudio()" style="display: none; padding: 10px 20px; background: #ff9800; border: none; border-radius: 8px; color: white; cursor: pointer; font-size: 14px;">
      ‚è∏Ô∏è Pause
    </button>
    <button id="stopBtn" onclick="stopAudio()" style="padding: 10px 20px; background: #f44336; border: none; border-radius: 8px; color: white; cursor: pointer; font-size: 14px;">
      ‚èπÔ∏è Arr√™ter
    </button>
    <div style="flex: 1; min-width: 200px;">
      <label style="font-size: 12px; opacity: 0.8;">Vitesse:</label>
      <input type="range" id="speedControl" min="0.5" max="2" step="0.1" value="1" onchange="updateSpeed()" style="width: 100%; margin-top: 5px;">
      <span id="speedValue" style="font-size: 12px;">1x</span>
    </div>
  </div>
  <div id="audioStatus" style="margin-top: 10px; font-size: 13px; opacity: 0.8;"></div>
</div>

<div class="bible-container" style="margin-top: 15px;">
  <div class="bible-books" id="bibleBooksContainer"></div>
  <div class="bible-viewer" id="bibleViewer">S√©lectionnez un livre...</div>
</div>

<script>
  const bibleBooks = [
    { id: 'GEN', fr: 'Gen√®se', chapters: 50 },
    { id: 'EXO', fr: 'Exode', chapters: 40 },
    { id: 'LEV', fr: 'L√©vitique', chapters: 27 },
    { id: 'NUM', fr: 'Nombres', chapters: 36 },
    { id: 'DEU', fr: 'Deut√©ronome', chapters: 34 },
    { id: 'JOS', fr: 'Josu√©', chapters: 24 },
    { id: 'JDG', fr: 'Juges', chapters: 21 },
    { id: 'RUT', fr: 'Ruth', chapters: 4 },
    { id: '1SA', fr: '1 Samuel', chapters: 31 },
    { id: '2SA', fr: '2 Samuel', chapters: 24 },
    { id: '1KI', fr: '1 Rois', chapters: 22 },
    { id: '2KI', fr: '2 Rois', chapters: 25 },
    { id: '1CH', fr: '1 Chroniques', chapters: 29 },
    { id: '2CH', fr: '2 Chroniques', chapters: 36 },
    { id: 'EZR', fr: 'Esdras', chapters: 10 },
    { id: 'NEH', fr: 'N√©h√©mie', chapters: 13 },
    { id: 'EST', fr: 'Esther', chapters: 10 },
    { id: 'JOB', fr: 'Job', chapters: 42 },
    { id: 'PSA', fr: 'Psaumes', chapters: 150 },
    { id: 'PRO', fr: 'Proverbes', chapters: 31 },
    { id: 'ECC', fr: 'Eccl√©siaste', chapters: 12 },
    { id: 'SNG', fr: 'Cantique', chapters: 8 },
    { id: 'ISA', fr: '√âsa√Øe', chapters: 66 },
    { id: 'JER', fr: 'J√©r√©mie', chapters: 52 },
    { id: 'LAM', fr: 'Lamentations', chapters: 5 },
    { id: 'EZK', fr: '√âz√©chiel', chapters: 48 },
    { id: 'DAN', fr: 'Daniel', chapters: 12 },
    { id: 'HOS', fr: 'Os√©e', chapters: 14 },
    { id: 'JOL', fr: 'Jo√´l', chapters: 3 },
    { id: 'AMO', fr: 'Amos', chapters: 9 },
    { id: 'OBA', fr: 'Abdias', chapters: 1 },
    { id: 'JON', fr: 'Jonas', chapters: 4 },
    { id: 'MIC', fr: 'Mich√©e', chapters: 7 },
    { id: 'NAM', fr: 'Nahum', chapters: 3 },
    { id: 'HAB', fr: 'Habacuc', chapters: 3 },
    { id: 'ZEP', fr: 'Sophonie', chapters: 3 },
    { id: 'HAG', fr: 'Agg√©e', chapters: 2 },
    { id: 'ZEC', fr: 'Zacharie', chapters: 14 },
    { id: 'MAL', fr: 'Malachie', chapters: 4 },
    { id: 'MAT', fr: 'Matthieu', chapters: 28 },
    { id: 'MRK', fr: 'Marc', chapters: 16 },
    { id: 'LUK', fr: 'Luc', chapters: 24 },
    { id: 'JHN', fr: 'Jean', chapters: 21 },
    { id: 'ACT', fr: 'Actes', chapters: 28 },
    { id: 'ROM', fr: 'Romains', chapters: 16 },
    { id: '1CO', fr: '1 Corinthiens', chapters: 16 },
    { id: '2CO', fr: '2 Corinthiens', chapters: 13 },
    { id: 'GAL', fr: 'Galates', chapters: 6 },
    { id: 'EPH', fr: '√âph√©siens', chapters: 6 },
    { id: 'PHP', fr: 'Philippiens', chapters: 4 },
    { id: 'COL', fr: 'Colossiens', chapters: 4 },
    { id: '1TH', fr: '1 Thessaloniciens', chapters: 5 },
    { id: '2TH', fr: '2 Thessaloniciens', chapters: 3 },
    { id: '1TI', fr: '1 Timoth√©e', chapters: 6 },
    { id: '2TI', fr: '2 Timoth√©e', chapters: 4 },
    { id: 'TIT', fr: 'Tite', chapters: 3 },
    { id: 'PHM', fr: 'Phil√©mon', chapters: 1 },
    { id: 'HEB', fr: 'H√©breux', chapters: 13 },
    { id: 'JAS', fr: 'Jacques', chapters: 5 },
    { id: '1PE', fr: '1 Pierre', chapters: 5 },
    { id: '2PE', fr: '2 Pierre', chapters: 3 },
    { id: '1JN', fr: '1 Jean', chapters: 5 },
    { id: '2JN', fr: '2 Jean', chapters: 1 },
    { id: '3JN', fr: '3 Jean', chapters: 1 },
    { id: 'JUD', fr: 'Jude', chapters: 1 },
    { id: 'REV', fr: 'Apocalypse', chapters: 22 }
  ];

  let bibleCurrBook = null;
  let bibleCurrChapter = 1;
  let speechSynthesis = window.speechSynthesis;
  let currentUtterance = null;
  let isPaused = false;
  let currentText = '';
  let bibleDB = null;

  // Initialize IndexedDB for offline Bible storage
  function initBibleDB() {
    const request = indexedDB.open('BibleOfflineDB', 1);
    request.onerror = () => console.error('IndexedDB error');
    request.onsuccess = (e) => { bibleDB = e.target.result; };
    request.onupgradeneeded = (e) => {
      const db = e.target.result;
      if (!db.objectStoreNames.contains('chapters')) {
        db.createObjectStore('chapters', { keyPath: 'key' });
      }
    };
  }

  function saveBibleChapter(bookId, chapter, data) {
    if (!bibleDB) return;
    const transaction = bibleDB.transaction(['chapters'], 'readwrite');
    const store = transaction.objectStore('chapters');
    store.put({ key: `${bookId}_${chapter}`, data, timestamp: Date.now() });
  }

  function getBibleChapter(bookId, chapter) {
    return new Promise((resolve, reject) => {
      if (!bibleDB) { reject('DB not ready'); return; }
      const transaction = bibleDB.transaction(['chapters'], 'readonly');
      const store = transaction.objectStore('chapters');
      const request = store.get(`${bookId}_${chapter}`);
      request.onsuccess = () => resolve(request.result?.data);
      request.onerror = () => reject('Not found');
    });
  }

  initBibleDB();

  function renderBibleBooks() {
    const container = document.getElementById('bibleBooksContainer');
    container.innerHTML = '';
    bibleBooks.forEach((book, idx) => {
      const btn = document.createElement('div');
      btn.className = 'bible-book-item';
      btn.textContent = book.fr;
      btn.onclick = () => loadBibleBook(idx);
      container.appendChild(btn);
    });
  }

  function changeBibleVersion() {
    if (bibleCurrBook !== null) {
      loadBibleBook(bibleCurrBook);
    }
  }

  async function loadBibleBook(index) {
    bibleCurrBook = index;
    bibleCurrChapter = 1;
    const book = bibleBooks[index];
    const viewer = document.getElementById('bibleViewer');
    const version = document.getElementById('bibleVersionSelect').value;
    viewer.innerHTML = '<em>Chargement...</em>';

    try {
      // Try offline cache first
      let data = await getBibleChapter(book.id + '_' + version, bibleCurrChapter).catch(() => null);
      
      if (!data) {
        // Fetch from API if not cached
        const response = await fetch(`https://bible-api.com/${book.id}+${bibleCurrChapter}?translation=${version}`);
        data = await response.json();
        saveBibleChapter(book.id + '_' + version, bibleCurrChapter, data);
        document.getElementById('offlineStatus').textContent = 'üì∂ Mode en ligne';
      } else {
        document.getElementById('offlineStatus').textContent = 'üíæ Mode hors ligne';
      }
      
      let html = `<div style="text-align: center; margin-bottom: 25px; padding: 15px; background: linear-gradient(135deg, rgba(106,17,203,0.3), rgba(37,117,252,0.2)); border-radius: 12px;"><strong style="font-size: 24px; color: #ffeb3b;">üìñ ${book.fr}</strong></div>`;
      
      // S√©lecteur de chapitres
      html += '<div style="text-align: center; margin: 20px 0; padding: 15px; background: rgba(255,255,255,0.05); border-radius: 10px;"><label style="font-size: 16px; font-weight: bold; margin-right: 10px;">Chapitre:</label><select id="chapterSelect" onchange="changeChapter()" style="padding: 10px 20px; border-radius: 8px; background: rgba(255,255,255,0.15); color: white; border: 2px solid rgba(255,255,255,0.3); font-size: 16px; font-weight: bold; cursor: pointer;">';
      for(let i = 1; i <= book.chapters; i++) {
        html += `<option value="${i}" ${i === bibleCurrChapter ? 'selected' : ''}>${i}</option>`;
      }
      html += '</select></div>';
      
      // Contenu du chapitre
      html += '<div style="margin-top: 25px;">';
      data.verses.forEach(verse => {
        html += `<div class="bible-verse"><strong>${verse.verse}</strong>${verse.text}</div>`;
      });
      html += '</div>';
      
      viewer.innerHTML = html;
      updateActiveBibleBook(index);
      
      // Store text for audio
      currentText = data.verses.map(v => v.text).join(' ');
      document.getElementById('audioControls').style.display = 'block';
      stopAudio();
      
      // Save to reading history
      saveReadingHistory(book.fr, bibleCurrChapter);
    } catch(err) {
      viewer.innerHTML = `‚ö†Ô∏è Erreur de chargement. V√©rifiez votre connexion Internet ou consultez un chapitre d√©j√† t√©l√©charg√©.<br><small>${err.message}</small>`;
      document.getElementById('audioControls').style.display = 'none';
      document.getElementById('offlineStatus').textContent = '‚ùå Hors ligne';
    }
  }

  async function changeChapter() {
    const chapter = parseInt(document.getElementById('chapterSelect').value);
    bibleCurrChapter = chapter;
    const book = bibleBooks[bibleCurrBook];
    const version = document.getElementById('bibleVersionSelect').value;
    const viewer = document.getElementById('bibleViewer');
    
    const currentScroll = viewer.scrollTop;
    viewer.innerHTML = '<em>Chargement...</em>';

    try {
      // Try offline cache first
      let data = await getBibleChapter(book.id + '_' + version, chapter).catch(() => null);
      
      if (!data) {
        // Fetch from API if not cached
        const response = await fetch(`https://bible-api.com/${book.id}+${chapter}?translation=${version}`);
        data = await response.json();
        saveBibleChapter(book.id + '_' + version, chapter, data);
        document.getElementById('offlineStatus').textContent = 'üì∂ Mode en ligne';
      } else {
        document.getElementById('offlineStatus').textContent = 'üíæ Mode hors ligne';
      }
      
      let html = `<div style="text-align: center; margin-bottom: 25px; padding: 15px; background: linear-gradient(135deg, rgba(106,17,203,0.3), rgba(37,117,252,0.2)); border-radius: 12px;"><strong style="font-size: 24px; color: #ffeb3b;">üìñ ${book.fr} - Chapitre ${chapter}</strong></div>`;
      
      html += '<div style="text-align: center; margin: 20px 0; padding: 15px; background: rgba(255,255,255,0.05); border-radius: 10px;"><label style="font-size: 16px; font-weight: bold; margin-right: 10px;">Chapitre:</label><select id="chapterSelect" onchange="changeChapter()" style="padding: 10px 20px; border-radius: 8px; background: rgba(255,255,255,0.15); color: white; border: 2px solid rgba(255,255,255,0.3); font-size: 16px; font-weight: bold; cursor: pointer;">';
      for(let i = 1; i <= book.chapters; i++) {
        html += `<option value="${i}" ${i === chapter ? 'selected' : ''}>${i}</option>`;
      }
      html += '</select></div>';
      
      html += '<div style="margin-top: 25px;">';
      data.verses.forEach(verse => {
        html += `<div class="bible-verse"><strong>${verse.verse}</strong>${verse.text}</div>`;
      });
      html += '</div>';
      
      viewer.innerHTML = html;
      
      // Store text for audio
      currentText = data.verses.map(v => v.text).join(' ');
      stopAudio();
      
      // Save to reading history
      saveReadingHistory(book.fr, chapter);
    } catch(err) {
      viewer.innerHTML = `‚ö†Ô∏è Erreur de chargement. V√©rifiez votre connexion Internet ou consultez un chapitre d√©j√† t√©l√©charg√©.<br><small>${err.message}</small>`;
      document.getElementById('offlineStatus').textContent = '‚ùå Hors ligne';
    }
  }

  function updateActiveBibleBook(index) {
    document.querySelectorAll('.bible-book-item').forEach((el, i) => {
      el.classList.toggle('active', i === index);
    });
  }

  function saveReadingHistory(bookName, chapter) {
    const history = JSON.parse(localStorage.getItem('bibleHistory_' + currentUser.phone)) || [];
    const entry = {
      book: bookName,
      chapter: chapter,
      date: new Date().toISOString(),
      timestamp: Date.now()
    };
    
    // Remove duplicates and keep last 50 entries
    const filtered = history.filter(h => !(h.book === bookName && h.chapter === chapter));
    filtered.unshift(entry);
    const limited = filtered.slice(0, 50);
    
    localStorage.setItem('bibleHistory_' + currentUser.phone, JSON.stringify(limited));
  }
  
  renderBibleBooks();

  // Audio functions
  function toggleAudio() {
    if (!currentText) {
      alert('Veuillez d\'abord s√©lectionner un chapitre');
      return;
    }

    if (isPaused) {
      speechSynthesis.resume();
      isPaused = false;
      document.getElementById('playBtn').style.display = 'none';
      document.getElementById('pauseBtn').style.display = 'inline-block';
      document.getElementById('audioStatus').textContent = 'üîä Lecture en cours...';
      return;
    }

    if (speechSynthesis.speaking) {
      return;
    }

    currentUtterance = new SpeechSynthesisUtterance(currentText);
    currentUtterance.lang = 'en-US';
    currentUtterance.rate = parseFloat(document.getElementById('speedControl').value);
    
    currentUtterance.onstart = () => {
      document.getElementById('playBtn').style.display = 'none';
      document.getElementById('pauseBtn').style.display = 'inline-block';
      document.getElementById('audioStatus').textContent = 'üîä Lecture en cours...';
    };

    currentUtterance.onend = () => {
      document.getElementById('playBtn').style.display = 'inline-block';
      document.getElementById('pauseBtn').style.display = 'none';
      document.getElementById('audioStatus').textContent = '‚úÖ Lecture termin√©e';
      isPaused = false;
    };

    currentUtterance.onerror = (e) => {
      document.getElementById('audioStatus').textContent = '‚ö†Ô∏è Erreur: ' + e.error;
      document.getElementById('playBtn').style.display = 'inline-block';
      document.getElementById('pauseBtn').style.display = 'none';
    };

    speechSynthesis.speak(currentUtterance);
  }

  function pauseAudio() {
    if (speechSynthesis.speaking && !isPaused) {
      speechSynthesis.pause();
      isPaused = true;
      document.getElementById('playBtn').style.display = 'inline-block';
      document.getElementById('pauseBtn').style.display = 'none';
      document.getElementById('audioStatus').textContent = '‚è∏Ô∏è En pause';
    }
  }

  function stopAudio() {
    speechSynthesis.cancel();
    isPaused = false;
    document.getElementById('playBtn').style.display = 'inline-block';
    document.getElementById('pauseBtn').style.display = 'none';
    document.getElementById('audioStatus').textContent = '';
  }

  function updateSpeed() {
    const speed = document.getElementById('speedControl').value;
    document.getElementById('speedValue').textContent = speed + 'x';
    if (currentUtterance && speechSynthesis.speaking) {
      // Restart with new speed
      const wasPlaying = !isPaused;
      stopAudio();
      if (wasPlaying) {
        setTimeout(toggleAudio, 100);
      }
    }
  }
</script>