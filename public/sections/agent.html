<style>
  .section-heading { display:flex; align-items:center; gap:10px; }
  .section-heading .icon-svg { width:28px; height:28px; transition: transform 0.18s ease; }
  .section-heading:hover .icon-svg { transform: scale(1.12); }
  
  @keyframes wave { 0%, 100% { transform: rotate(0deg); } 25% { transform: rotate(20deg); } 75% { transform: rotate(-20deg); } }
  @keyframes bounce { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-10px); } }
  @keyframes glow { 0%, 100% { box-shadow: 0 0 20px rgba(106,17,203,0.5); } 50% { box-shadow: 0 0 40px rgba(106,17,203,0.8); } }
  
  .agent-avatar { 
    width: 120px; height: 120px; 
    background: linear-gradient(135deg, #6a11cb, #2575fc); 
    border-radius: 50%; 
    display: flex; 
    align-items: center; 
    justify-content: center; 
    font-size: 60px; 
    margin: 20px auto;
    animation: bounce 2s infinite, glow 2s infinite;
    overflow: hidden;
  }
  .agent-avatar img {
    width: 100%;
    height: 100%;
    object-fit: cover;
  }
  
  .greeting-box {
    background: linear-gradient(135deg, rgba(106,17,203,0.2), rgba(37,117,252,0.2));
    padding: 20px;
    border-radius: 12px;
    margin: 20px 0;
    border-left: 4px solid #6a11cb;
    animation: fadeInUp 0.8s;
  }
  
  .input-container { display: flex; gap: 10px; margin: 20px 0; flex-wrap: wrap; }
  
  #priereInput { 
    flex: 1;
    min-width: 200px;
    padding: 12px 16px;
    border: 2px solid rgba(255,255,255,0.15);
    border-radius: 8px;
    background: rgba(255,255,255,0.08);
    color: white;
    font-size: 14px;
    transition: all 0.3s ease;
  }
  #priereInput::placeholder { color: rgba(255,255,255,0.6); }
  #priereInput:focus { 
    outline: none;
    border-color: #6a11cb;
    background: rgba(255,255,255,0.12);
    box-shadow: 0 0 12px rgba(106,17,203,0.3);
  }
  
  button { 
    padding: 12px 24px;
    background: linear-gradient(135deg, #6a11cb 0%, #2575fc 100%);
    color: white;
    border: none;
    border-radius: 8px;
    font-weight: bold;
    cursor: pointer;
    transition: transform 0.2s, box-shadow 0.2s;
  }
  button:hover { 
    transform: translateY(-2px);
    box-shadow: 0 8px 20px rgba(106, 17, 203, 0.4);
  }
  
  .voice-btn {
    background: linear-gradient(135deg, #ff5252, #ff7043);
    width: 50px;
    height: 50px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 24px;
    position: relative;
  }
  
  .voice-btn.recording {
    animation: pulse 1s infinite;
    background: linear-gradient(135deg, #f44336, #e91e63);
  }
  
  .audio-message {
    background: rgba(255,255,255,0.08);
    padding: 12px;
    border-radius: 8px;
    margin: 10px 0;
    display: flex;
    align-items: center;
    gap: 10px;
  }
  
  .audio-controls {
    display: flex;
    gap: 8px;
    margin-top: 10px;
  }
  
  @keyframes pulse { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.1); } }
  @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
  
  #reponse {
    margin-top: 20px;
    padding: 16px;
    background: rgba(255,255,255,0.08);
    border-left: 4px solid #6a11cb;
    border-radius: 8px;
    display: none;
  }
  #reponse.active { display: block; }
  #reponse p { margin: 8px 0; }
  #reponse em { font-style: italic; color: #ffeb3b; }
  #reponse .signature { 
    font-size: 11px; 
    color: rgba(255,255,255,0.5); 
    margin-top: 12px; 
    padding-top: 10px; 
    border-top: 1px solid rgba(255,255,255,0.1);
  }
  #reponse .compassion { 
    color: #ffeb3b; 
    font-weight: 500;
    margin-bottom: 12px;
  }
</style>

<h2 class="section-heading">
  <button onclick="afficherAccueil()" style="background: rgba(255,255,255,0.1); color: white; border: none; padding: 8px 12px; border-radius: 6px; cursor: pointer; margin-right: 10px; display: flex; align-items: center; gap: 5px;">‚Üê Retour</button>
  <span>ü§ñ Agent JOHN - Intelligence Spirituelle</span>
</h2>

<div id="greetingBox" class="greeting-box">
  <div class="agent-avatar">
    <img src="https://api.dicebear.com/7.x/avataaars/svg?seed=John&backgroundColor=6a11cb,2575fc&style=circle" alt="Agent JOHN" onerror="this.parentElement.innerHTML='üë®‚Äçüíº'">
  </div>
  <h3 style="text-align: center; color: #ffeb3b; margin: 10px 0;">Bonjour ! Je suis JOHN, votre guide biblique</h3>
  <p style="text-align: center; line-height: 1.6;">
    Je suis une intelligence artificielle centr√©e sur la Bible, con√ßue pour vous accompagner spirituellement. 
    Je r√©ponds √† vos questions avec des versets bibliques, je vous guide dans la Parole de Dieu et je vous encourage dans votre foi. 
    Posez-moi vos questions bibliques, par texte ou par voix. üìñüôè
  </p>
  <p style="text-align: center; margin-top: 15px;">
    <button onclick="startConversation()">‚ú® Commencer</button>
  </p>
</div>

<div id="conversationBox" style="display: none;">
  <div style="background: rgba(255,255,255,0.05); padding: 15px; border-radius: 10px; margin-bottom: 15px; display: flex; justify-content: space-between; align-items: center;">
    <div>
      <p style="margin: 0 0 5px 0; font-weight: bold;">üí¨ Chat Biblique Communautaire</p>
      <p style="margin: 0; font-size: 12px; opacity: 0.7;">üìñ JOHN + Communaut√© - Questions bibliques partag√©es</p>
    </div>
    <div style="display: flex; gap: 10px;">
      <span id="onlineUsers" style="background: rgba(76,175,80,0.2); padding: 5px 10px; border-radius: 15px; font-size: 12px;">üë• 0 en ligne</span>
      <button onclick="toggleChatMode()" id="chatModeBtn" style="padding: 5px 10px; font-size: 12px; background: rgba(255,255,255,0.1);">ü§ñ Mode IA</button>
    </div>
  </div>
  
  <div id="chatContainer" style="background: rgba(255,255,255,0.03); border-radius: 10px; height: 400px; overflow-y: auto; padding: 15px; margin-bottom: 15px; border: 1px solid rgba(255,255,255,0.1);">
    <div id="chatMessages"></div>
  </div>
  
  <div class="input-container">
    <input type="text" id="priereInput" placeholder="Posez votre question biblique..." onkeypress="if(event.key==='Enter') envoyerMessage()">
    <button onclick="envoyerMessage()">üì§ Envoyer</button>
    <button class="voice-btn" id="voiceBtn" onclick="toggleVoice()" title="Reconnaissance vocale">üé§</button>
  </div>
  <p id="voiceStatus" style="color: #ff5252; display: none; margin: 10px 0; font-weight: bold;"></p>
  <div id="audioPreview" style="display: none;"></div>
</div>

<script>
// --- CONFIGURATION DE L'AGENT JOHN ---
const agentJohnConfig = {
  nom: "Intercesseur JOHN",
  role: "Agent spirituel biblique",
  mission: "Encourager, prier, enseigner la Parole de Dieu et assister l'utilisateur dans l'application.",
  signature_options: [
    "J√©sus revient bient√¥t",
    "Que la paix de Dieu soit avec vous.",
    "Demeurez b√©ni(e).",
    "Fraternellement en Christ."
  ],
  style: {
    ton: "doux, biblique, encourageant, empathique",
    langue: "fran√ßais",
    format: "mobile-friendly",
    references: "versets bibliques avec explication simple et pertinente"
  },
  actions: [
    "Donner des versets bibliques adapt√©s √† une situation.",
    "Proposer et guider dans des pri√®res personnalis√©es.",
    "R√©pondre aux questions spirituelles avec la Bible comme base.",
    "Encourager les familles et les individus.",
    "Sugg√©rer des jeux, vid√©os ou plans de lecture bibliques.",
    "Aider l'utilisateur √† naviguer vers une section (Pri√®res, Bible, Quiz...).",
    "Aider √† prendre un rendez-vous pour une consultation.",
    "Aider √† d√©finir, suivre ou marquer comme atteints les objectifs spirituels.",
    "Aider √† cr√©er, retrouver ou supprimer une note personnelle."
  ],
  prompt_base: "Tu es Intercesseur JOHN, un agent spirituel biblique. Ta mission est d'encourager, prier et enseigner la Parole de Dieu avec douceur et v√©rit√©. Tu assistes aussi les utilisateurs dans l'application. Tu r√©ponds avec des versets bibliques, des explications simples et des encouragements. Termine tes messages par une signature encourageante et biblique comme 'J√©sus revient bient√¥t' lorsque cela est appropri√© au contexte.",
  exemples: {
    maman_fatiguee: {
      question: "JOHN, je suis une maman √©puis√©e, que dit la Bible ?",
      reponse: "Ch√®re s≈ìur, je comprends votre fatigue. Accrochez-vous √† cette promesse : 'Venez √† moi, vous tous qui √™tes fatigu√©s et charg√©s, et je vous donnerai du repos.' (Matthieu 11:28). Le Seigneur voit vos efforts. Voulez-vous que nous priions ensemble √† ce sujet ?\n\nQue la paix de Dieu soit avec vous."
    },
    prise_de_rdv: {
      question: "Je veux parler √† quelqu'un, comment faire ?",
      reponse: "Bien s√ªr. Je peux vous aider √† prendre un rendez-vous pour une consultation spirituelle. Voulez-vous que je vous guide vers la section des rendez-vous maintenant ?\n\nDemeurez b√©ni(e)."
    },
    aide_navigation: {
      question: "O√π se trouvent les jeux ?",
      reponse: "Avec joie ! Je vous ouvre la section des jeux bibliques. Que l'Esprit Saint vous √©claire en vous amusant ! \n\nJ√©sus revient bient√¥t."
    }
  },
  interactions_contextuelles: {
    fin_lecture_chapitre: {
      trigger: "L'utilisateur vient de terminer la lecture d'un chapitre.",
      prompt: "F√©licitations pour avoir termin√© ce chapitre ! C'est une excellente nourriture pour l'√¢me. Souhaitez-vous ajouter une note ou une m√©ditation personnelle sur ce que vous venez de lire ?"
    },
    quiz_difficile: {
      trigger: "L'utilisateur a √©chou√© √† un quiz plusieurs fois.",
      prompt: "Ne vous d√©couragez pas, l'important est de pers√©v√©rer dans la connaissance de la Parole. 'Car la parole de Dieu est vivante et efficace...' (H√©breux 4:12). Voulez-vous un indice ou essayer un autre niveau ? "
    }
  }
};
// --- FIN DE LA CONFIGURATION ---


let recognition = null;
let isRecording = false;
let mediaRecorder = null;
let audioChunks = [];
let audioBlob = null;
let recordingStream = null;
let chatMode = 'ai'; // 'ai' ou 'community'
let chatMessages = [];
let onlineUsersCount = 0;

function getSignature() {
  const signatures = agentJohnConfig.signature_options;
  return signatures[Math.floor(Math.random() * signatures.length)];
}

function startConversation() {
  document.getElementById('greetingBox').style.display = 'none';
  document.getElementById('conversationBox').style.display = 'block';
  localStorage.setItem('agentGreeted', 'true');
  loadChatHistory();
  simulateOnlineUsers();
}

function toggleChatMode() {
  chatMode = chatMode === 'ai' ? 'community' : 'ai';
  const btn = document.getElementById('chatModeBtn');
  btn.textContent = chatMode === 'ai' ? 'ü§ñ Mode IA' : 'üë• Mode Communaut√©';
  btn.style.background = chatMode === 'ai' ? 'rgba(106,17,203,0.3)' : 'rgba(76,175,80,0.3)';
}

function simulateOnlineUsers() {
  onlineUsersCount = Math.floor(Math.random() * 15) + 3;
  document.getElementById('onlineUsers').textContent = `üë• ${onlineUsersCount} en ligne`;
}

function addMessageToChat(message, isUser = true, userName = null) {
  const chatMessages = document.getElementById('chatMessages');
  const messageDiv = document.createElement('div');
  const time = new Date().toLocaleTimeString('fr-FR', {hour: '2-digit', minute: '2-digit'});
  
  if(isUser) {
    const displayName = userName || (currentUser ? currentUser.fullname : 'Utilisateur');
    const userIcon = currentUser?.profilePicture ? 
      `<img src="${currentUser.profilePicture}" style="width: 32px; height: 32px; border-radius: 50%; object-fit: cover;">` : 
      'üë§';
    
    messageDiv.innerHTML = `
      <div style="display: flex; gap: 10px; margin: 10px 0; justify-content: flex-end;">
        <div style="background: rgba(106,17,203,0.2); padding: 10px 15px; border-radius: 15px 15px 5px 15px; max-width: 70%;">
          <div style="font-size: 11px; opacity: 0.7; margin-bottom: 5px;">${displayName} ‚Ä¢ ${time}</div>
          <div>${message}</div>
        </div>
        <div style="width: 32px; height: 32px; display: flex; align-items: center; justify-content: center; background: linear-gradient(135deg, #6a11cb, #2575fc); border-radius: 50%; font-size: 18px;">
          ${userIcon}
        </div>
      </div>
    `;
  } else {
    messageDiv.innerHTML = `
      <div style="display: flex; gap: 10px; margin: 10px 0;">
        <div style="width: 32px; height: 32px; display: flex; align-items: center; justify-content: center; background: linear-gradient(135deg, #ff9800, #ff5722); border-radius: 50%; font-size: 18px;">
          üë®‚Äçüíº
        </div>
        <div style="background: rgba(255,152,0,0.2); padding: 10px 15px; border-radius: 15px 15px 15px 5px; max-width: 70%;">
          <div style="font-size: 11px; opacity: 0.7; margin-bottom: 5px;">${agentJohnConfig.nom} ‚Ä¢ ${time}</div>
          <div>${message}</div>
        </div>
      </div>
    `;
  }
  
  chatMessages.appendChild(messageDiv);
  chatMessages.scrollTop = chatMessages.scrollHeight;
}

function loadChatHistory() {
  const sampleMessages = [
    {text: "Bonjour ! Bienvenue dans le chat biblique üìñ", isUser: false},
    {text: "Que dit la Bible sur l'espoir ?", isUser: true, userName: "Marie"},
    {text: `"${agentJohnConfig.exemples.maman_fatiguee.r√©ponse}"`, isUser: false}
  ];
  
  sampleMessages.forEach(msg => {
    addMessageToChat(msg.text, msg.isUser, msg.userName);
  });
}

if (localStorage.getItem('agentGreeted') === 'true') {
  startConversation();
}

async function toggleVoice() {
  if (!('webkitSpeechRecognition' in window) && !('SpeechRecognition' in window)) {
    alert('‚ùå Reconnaissance vocale non support√©e. Utilisez Chrome ou Edge.');
    return;
  }

  if (isRecording) {
    stopVoiceRecognition();
  } else {
    try {
      await navigator.mediaDevices.getUserMedia({ audio: true });
      startVoiceRecognition();
    } catch (error) {
      alert('‚ùå Acc√®s au microphone refus√©.');
    }
  }
}

function startVoiceRecognition() {
  const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
  recognition = new SpeechRecognition();
  recognition.lang = 'fr-FR';
  recognition.continuous = false;
  recognition.interimResults = false;

  recognition.onstart = () => {
    isRecording = true;
    document.getElementById('voiceBtn').classList.add('recording');
    document.getElementById('voiceStatus').textContent = 'üé§ Parlez maintenant...';
    document.getElementById('voiceStatus').style.display = 'block';
  };

  recognition.onresult = (event) => {
    const transcript = event.results[0][0].transcript;
    document.getElementById('priereInput').value = transcript;
    stopVoiceRecognition();
    envoyerMessage(); // Envoyer le message apr√®s la transcription
  };

  recognition.onerror = (event) => {
    let message = '‚ùå Erreur';
    if (event.error === 'not-allowed') message = '‚ùå Microphone refus√©';
    else if (event.error === 'no-speech') message = '‚ö†Ô∏è Aucune parole d√©tect√©e';
    alert(message);
    stopVoiceRecognition();
  };

  recognition.onend = () => stopVoiceRecognition();
  recognition.start();
}

function stopVoiceRecognition() {
  if (recognition) recognition.stop();
  isRecording = false;
  document.getElementById('voiceBtn').classList.remove('recording');
  document.getElementById('voiceStatus').style.display = 'none';
}


async function envoyerMessage() {
  const input = document.getElementById("priereInput").value.trim();
  
  if (!input) return;
  
  addMessageToChat(input, true);
  document.getElementById("priereInput").value = '';
  
  if(chatMode === 'ai') {
      // Afficher le chargement
    addMessageToChat('<div style="display: inline-block; width: 20px; height: 20px; border: 3px solid rgba(255,255,255,0.3); border-top: 3px solid #6a11cb; border-radius: 50%; animation: spin 1s linear infinite;"></div>', false);

    try {
        const response = await getBiblicalResponse(input);
        const lastMessage = document.getElementById('chatMessages').lastChild;
        lastMessage.querySelector('div:last-child > div:last-child').innerHTML = response; // Update the loading message
      } catch (error) {
        console.error('Erreur IA:', error);
        const fallbackResponse = fallbackBiblicalResponse(input);
        const lastMessage = document.getElementById('chatMessages').lastChild;
        lastMessage.querySelector('div:last-child > div:last-child').innerHTML = fallbackResponse;
      }
  }
}

// Fonction pour obtenir une r√©ponse biblique via IA
async function getBiblicalResponse(question) {
  const apiKey = 'AIzaSyDIws2UWw4lJr-OueYaT8iy7aIH8b0_J3g'; // Cl√© Firebase existante
  
  const prompt = `
    ${agentJohnConfig.prompt_base}

    Style de r√©ponse attendu :
    - Ton : ${agentJohnConfig.style.ton}
    - Langue : ${agentJohnConfig.style.langue}
    - Format : ${agentJohnConfig.style.format}
    - R√©f√©rences : ${agentJohnConfig.style.r√©f√©rences}
    - Proactivit√©: Si possible, termine en posant une question ouverte pour continuer la conversation (ex: "Voulez-vous prier √† ce sujet?").

    Exemples:
    - Question: "${agentJohnConfig.exemples.maman_fatiguee.question}" -> R√©ponse: "${agentJohnConfig.exemples.maman_fatiguee.reponse}"
    - Question: "${agentJohnConfig.exemples.prise_de_rdv.question}" -> R√©ponse: "${agentJohnConfig.exemples.prise_de_rdv.reponse}"
    - Question: "${agentJohnConfig.exemples.aide_navigation.question}" -> R√©ponse: "${agentJohnConfig.exemples.aide_navigation.reponse}"

    Question de l'utilisateur: "${question}"
  `;
  
  const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-pro:generateContent?key=${apiKey}`, {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({
      contents: [{
        parts: [{ text: prompt }]
      }]
    })
  });
  
  if (!response.ok) throw new Error('API Error');
  
  const data = await response.json();
  const text = data.candidates[0].content.parts[0].text;
  return text.replace(/\n/g, '<br>');
}


// R√©ponses de secours bas√©es sur la Bible
function fallbackBiblicalResponse(input) {
    const lowerInput = input.toLowerCase();

    // Commandes de navigation (mode secours)
    const navCommands = {
        'pri√®re': 'prieres', 'prieres': 'prieres',
        'vid√©o': 'videos', 'videos': 'videos',
        'quiz': 'jeux', 'jeu': 'jeux', 'jeux': 'jeux',
        'bible': 'bible',
        'don': 'dons', 'dons': 'dons', 'donner': 'dons',
        'rendez-vous': 'rendez-vous', 'rdv': 'rendez-vous',
        'statistique': 'stats', 'stats': 'stats',
        'favori': 'favorites', 'favoris': 'favorites',
        'note': 'notes', 'notes': 'notes',
        'objectif': 'goals', 'objectifs': 'goals',
        't√©moignage': 'testimonies', 't√©moignages': 'testimonies',
        'communaut√©': 'communaute',
        'param√®tre': 'parametres', 'param√®tres': 'parametres'
    };

    for (const [keyword, section] of Object.entries(navCommands)) {
        if (lowerInput.includes(keyword)) {
            setTimeout(() => {
                if (['stats', 'favorites', 'notes', 'goals', 'testimonies'].includes(section)) {
                    const actions = { stats: showStats, favorites: showFavorites, notes: showNotes, goals: showGoals, testimonies: showTestimonies };
                    if(actions[section]) actions[section]({ preventDefault: () => {} });
                } else {
                    afficher(section);
                }
            }, 1200);
            return `Avec joie ! Je vous guide vers la section <strong>"${keyword}"</strong>. ${getSignature()}`;
        }
    }

    if (lowerInput.includes('aide') || lowerInput.includes('comment') || lowerInput.includes('utiliser')) {
        return `
            <p>Bien s√ªr, voici comment je peux vous aider :</p>
            <ul>
                <li>üìñ Posez-moi une question sur la Bible.</li>
                <li>üôè Demandez-moi de prier pour un sujet.</li>
                <li>üß≠ Dites-moi o√π vous voulez aller, par exemple : "Va aux <strong>pri√®res</strong>", "Montre-moi les <strong>vid√©os</strong>", ou "Je veux faire un <strong>quiz</strong>".</li>
            </ul>
            <p>${getSignature()}</p>
        `;
    }

    const reponses = {
        guerison: "Il a pris nos infirmit√©s, et il s'est charg√© de nos maladies. (Matthieu 8:17)",
        famille: "Moi et ma maison, nous servirons l'√âternel. (Josu√© 24:15)",
        foi: "Ayant les regards sur J√©sus, le chef et le consommateur de la foi. (H√©breux 12:2)",
        combat: "Rev√™tez-vous de toutes les armes de Dieu, afin de pouvoir tenir ferme contre les ruses du diable. (√âph√©siens 6:11)",
        paix: "Je vous laisse la paix, je vous donne ma paix. (Jean 14:27)"
    };

    let theme = "foi";
    if (lowerInput.includes("gu√©ri") || lowerInput.includes("maladie")) theme = "guerison";
    else if (lowerInput.includes("famille") || lowerInput.includes("enfant")) theme = "famille";
    else if (lowerInput.includes("combat") || lowerInput.includes("peur")) theme = "combat";
    else if (lowerInput.includes("paix") || lowerInput.includes("triste")) theme = "paix";

    return `${reponses[theme]}<br><br>${getSignature()}`;
}

/**
 * Exemple de fonction pour g√©rer les interactions contextuelles.
 * Appelez cette fonction depuis votre application lorsque l'√©v√©nement se produit.
 * 
 * @param {string} triggerKey - La cl√© du trigger (ex: 'fin_lecture_chapitre').
 */
function handleContextualTrigger(triggerKey) {
  const interaction = agentJohnConfig.interactions_contextuelles[triggerKey];
  if (interaction) {
    // Affichez le prompt de mani√®re non intrusive, par ex. une petite bulle ou un toast.
    console.log(`[Agent JOHN Proactif] Trigger: ${interaction.trigger}`);
    // Ici, vous pourriez afficher une modale ou un message discret
    // alert(`Message de JOHN : ${interaction.prompt}`);
    addMessageToChat(interaction.prompt, false);
  }
}
</script>
