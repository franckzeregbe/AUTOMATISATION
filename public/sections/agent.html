<style>
  .section-heading { display:flex; align-items:center; gap:10px; }
  .section-heading .icon-svg { width:28px; height:28px; transition: transform 0.18s ease; }
  .section-heading:hover .icon-svg { transform: scale(1.12); }
  
  @keyframes wave { 0%, 100% { transform: rotate(0deg); } 25% { transform: rotate(20deg); } 75% { transform: rotate(-20deg); } }
  @keyframes bounce { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-10px); } }
  @keyframes glow { 0%, 100% { box-shadow: 0 0 20px rgba(106,17,203,0.5); } 50% { box-shadow: 0 0 40px rgba(106,17,203,0.8); } }
  
  .agent-avatar { 
    width: 120px; height: 120px; 
    background: linear-gradient(135deg, #6a11cb, #2575fc); 
    border-radius: 50%; 
    display: flex; 
    align-items: center; 
    justify-content: center; 
    font-size: 60px; 
    margin: 20px auto;
    animation: bounce 2s infinite, glow 2s infinite;
    overflow: hidden;
  }
  .agent-avatar img {
    width: 100%;
    height: 100%;
    object-fit: cover;
  }
  
  .greeting-box {
    background: linear-gradient(135deg, rgba(106,17,203,0.2), rgba(37,117,252,0.2));
    padding: 20px;
    border-radius: 12px;
    margin: 20px 0;
    border-left: 4px solid #6a11cb;
    animation: fadeInUp 0.8s;
  }
  
  .input-container { display: flex; gap: 10px; margin: 20px 0; flex-wrap: wrap; }
  
  #priereInput { 
    flex: 1;
    min-width: 200px;
    padding: 12px 16px;
    border: 2px solid rgba(255,255,255,0.15);
    border-radius: 8px;
    background: rgba(255,255,255,0.08);
    color: white;
    font-size: 14px;
    transition: all 0.3s ease;
  }
  #priereInput::placeholder { color: rgba(255,255,255,0.6); }
  #priereInput:focus { 
    outline: none;
    border-color: #6a11cb;
    background: rgba(255,255,255,0.12);
    box-shadow: 0 0 12px rgba(106,17,203,0.3);
  }
  
  button { 
    padding: 12px 24px;
    background: linear-gradient(135deg, #6a11cb 0%, #2575fc 100%);
    color: white;
    border: none;
    border-radius: 8px;
    font-weight: bold;
    cursor: pointer;
    transition: transform 0.2s, box-shadow 0.2s;
  }
  button:hover { 
    transform: translateY(-2px);
    box-shadow: 0 8px 20px rgba(106, 17, 203, 0.4);
  }
  
  .voice-btn {
    background: linear-gradient(135deg, #ff5252, #ff7043);
    width: 50px;
    height: 50px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 24px;
    position: relative;
  }
  
  .voice-btn.recording {
    animation: pulse 1s infinite;
    background: linear-gradient(135deg, #f44336, #e91e63);
  }
  
  .audio-message {
    background: rgba(255,255,255,0.08);
    padding: 12px;
    border-radius: 8px;
    margin: 10px 0;
    display: flex;
    align-items: center;
    gap: 10px;
  }
  
  .audio-controls {
    display: flex;
    gap: 8px;
    margin-top: 10px;
  }
  
  @keyframes pulse { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.1); } }
  
  #reponse {
    margin-top: 20px;
    padding: 16px;
    background: rgba(255,255,255,0.08);
    border-left: 4px solid #6a11cb;
    border-radius: 8px;
    display: none;
  }
  #reponse.active { display: block; }
  #reponse p { margin: 8px 0; }
  #reponse em { font-style: italic; color: #ffeb3b; }
  #reponse .signature { 
    font-size: 11px; 
    color: rgba(255,255,255,0.5); 
    margin-top: 12px; 
    padding-top: 10px; 
    border-top: 1px solid rgba(255,255,255,0.1);
  }
  #reponse .compassion { 
    color: #ffeb3b; 
    font-weight: 500;
    margin-bottom: 12px;
  }
</style>

<h2 class="section-heading"><span>ü§ñ Agent JOHN - Intelligence Spirituelle</span></h2>

<div id="greetingBox" class="greeting-box">
  <div class="agent-avatar">
    <img src="https://api.dicebear.com/7.x/avataaars/svg?seed=John&backgroundColor=6a11cb,2575fc&style=circle" alt="Agent JOHN" onerror="this.parentElement.innerHTML='ü§ñ'">
  </div>
  <h3 style="text-align: center; color: #ffeb3b; margin: 10px 0;">Bonjour ! Je suis JOHN, votre guide biblique</h3>
  <p style="text-align: center; line-height: 1.6;">
    Je suis une intelligence artificielle centr√©e sur la Bible, con√ßue pour vous accompagner spirituellement. 
    Je r√©ponds √† vos questions avec des versets bibliques, je vous guide dans la Parole de Dieu et je vous encourage dans votre foi. 
    Posez-moi vos questions bibliques, par texte ou par voix. üìñüôè
  </p>
  <p style="text-align: center; margin-top: 15px;">
    <button onclick="startConversation()">‚ú® Commencer</button>
  </p>
</div>

<div id="conversationBox" style="display: none;">
  <div style="background: rgba(255,255,255,0.05); padding: 15px; border-radius: 10px; margin-bottom: 15px;">
    <p style="margin: 0 0 5px 0; font-weight: bold;">‚úçÔ∏è Posez votre question biblique :</p>
    <p style="margin: 0; font-size: 12px; opacity: 0.7;">üìñ Je r√©ponds avec la Bible - √âcrivez ou parlez au micro (üé§)</p>
  </div>
  <div class="input-container">
    <input type="text" id="priereInput" placeholder="Ex: Que dit la Bible sur la gu√©rison ?" onkeypress="if(event.key==='Enter') envoyerPriere()">
    <button onclick="envoyerPriere()">üì§ Envoyer</button>
    <button class="voice-btn" id="voiceBtn" onclick="toggleVoice()" title="Reconnaissance vocale">üé§</button>
  </div>
  <p id="voiceStatus" style="color: #ff5252; display: none; margin: 10px 0; font-weight: bold;"></p>
  <div id="audioPreview" style="display: none;"></div>
  <div id="reponse"></div>
</div>

<script>
let recognition = null;
let isRecording = false;
let mediaRecorder = null;
let audioChunks = [];
let audioBlob = null;
let recordingStream = null;

function startConversation() {
  document.getElementById('greetingBox').style.display = 'none';
  document.getElementById('conversationBox').style.display = 'block';
  localStorage.setItem('agentGreeted', 'true');
}

if (localStorage.getItem('agentGreeted') === 'true') {
  startConversation();
}

async function toggleVoice() {
  if (!('webkitSpeechRecognition' in window) && !('SpeechRecognition' in window)) {
    alert('‚ùå Reconnaissance vocale non support√©e. Utilisez Chrome ou Edge.');
    return;
  }

  if (isRecording) {
    stopVoiceRecognition();
  } else {
    try {
      await navigator.mediaDevices.getUserMedia({ audio: true });
      startVoiceRecognition();
    } catch (error) {
      alert('‚ùå Acc√®s au microphone refus√©.');
    }
  }
}

function startVoiceRecognition() {
  const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
  recognition = new SpeechRecognition();
  recognition.lang = 'fr-FR';
  recognition.continuous = false;
  recognition.interimResults = false;

  recognition.onstart = () => {
    isRecording = true;
    document.getElementById('voiceBtn').classList.add('recording');
    document.getElementById('voiceStatus').textContent = 'üé§ Parlez maintenant...';
    document.getElementById('voiceStatus').style.display = 'block';
  };

  recognition.onresult = (event) => {
    const transcript = event.results[0][0].transcript;
    document.getElementById('priereInput').value = transcript;
    stopVoiceRecognition();
  };

  recognition.onerror = (event) => {
    let message = '‚ùå Erreur';
    if (event.error === 'not-allowed') message = '‚ùå Microphone refus√©';
    else if (event.error === 'no-speech') message = '‚ö†Ô∏è Aucune parole d√©tect√©e';
    alert(message);
    stopVoiceRecognition();
  };

  recognition.onend = () => stopVoiceRecognition();
  recognition.start();
}

function stopVoiceRecognition() {
  if (recognition) recognition.stop();
  isRecording = false;
  document.getElementById('voiceBtn').classList.remove('recording');
  document.getElementById('voiceStatus').style.display = 'none';
}

// Audio Recording Functions
async function toggleRecording() {
  if (mediaRecorder && mediaRecorder.state === 'recording') {
    stopAudioRecording();
  } else {
    try {
      await startAudioRecording();
    } catch (error) {
      alert('‚ùå Impossible d\'acc√©der au microphone.');
    }
  }
}

async function startAudioRecording() {
  audioChunks = [];
  recordingStream = await navigator.mediaDevices.getUserMedia({ audio: true });
  mediaRecorder = new MediaRecorder(recordingStream);

  mediaRecorder.ondataavailable = (event) => {
    audioChunks.push(event.data);
  };

  mediaRecorder.onstop = () => {
    audioBlob = new Blob(audioChunks, { type: 'audio/webm' });
    displayAudioPreview();
    recordingStream.getTracks().forEach(track => track.stop());
  };

  mediaRecorder.start();
  document.getElementById('recordBtn').classList.add('recording');
  document.getElementById('voiceStatus').textContent = 'üî¥ Enregistrement audio en cours... (Cliquez pour arr√™ter)';
  document.getElementById('voiceStatus').style.display = 'block';
}

function stopAudioRecording() {
  if (mediaRecorder && mediaRecorder.state === 'recording') {
    mediaRecorder.stop();
    document.getElementById('recordBtn').classList.remove('recording');
    document.getElementById('voiceStatus').style.display = 'none';
  }
}

function displayAudioPreview() {
  const preview = document.getElementById('audioPreview');
  const audioUrl = URL.createObjectURL(audioBlob);
  
  preview.innerHTML = `
    <div class="audio-message">
      <span>üéµ Message audio enregistr√©</span>
      <audio controls src="${audioUrl}" style="flex: 1; max-width: 300px;"></audio>
      <div class="audio-controls">
        <button onclick="sendAudioMessage()" style="padding: 8px 16px; font-size: 13px;">üì§ Envoyer</button>
        <button onclick="cancelAudio()" style="padding: 8px 16px; font-size: 13px; background: #f44336;">‚ùå Annuler</button>
      </div>
    </div>
  `;
  preview.style.display = 'block';
}

function sendAudioMessage() {
  if (!audioBlob) return;
  
  // Simuler l'envoi (dans une vraie app, vous enverriez √† un serveur)
  const userName = currentUser ? currentUser.fullname.split(' ')[0] : 'ami(e)';
  const reponseDiv = document.getElementById('reponse');
  reponseDiv.innerHTML = `
    <p class="compassion">üìñ ${userName}, j'ai re√ßu et analys√© votre message audio.</p>
    <p style="background: rgba(255,235,59,0.1); padding: 15px; border-left: 4px solid #ffeb3b; border-radius: 8px; margin: 15px 0;">
      <strong style="color: #ffeb3b;">üìú Verset biblique :</strong><br>
      <em style="font-size: 16px; line-height: 1.8;">"L'√âternel entend quand je crie √† lui." - Psaume 4:3</em>
    </p>
    <p><strong>üí° Encouragement biblique :</strong><br>La Bible nous assure que Dieu √©coute nos pri√®res. Il conna√Æt les d√©sirs de votre c≈ìur et agit selon Sa volont√© parfaite. Continuez √† Lui faire confiance et √† m√©diter Sa Parole.</p>
    <p style="margin-top: 15px; padding: 12px; background: rgba(106,17,203,0.2); border-radius: 8px; font-size: 14px;">
      üìñ <strong>JOHN - IA Biblique</strong> : Toutes mes r√©ponses sont bas√©es sur les √âcritures. Posez-moi d'autres questions bibliques.
    </p>
    <p class="signature">‚ú® JOHN - Agent IA Biblique ‚Ä¢ "Ta parole est une lampe √† mes pieds" (Psaume 119:105)</p>
  `;
  reponseDiv.classList.add('active');
  
  cancelAudio();
  alert('‚úÖ Message audio envoy√© avec succ√®s !');
}

function cancelAudio() {
  document.getElementById('audioPreview').style.display = 'none';
  document.getElementById('audioPreview').innerHTML = '';
  audioBlob = null;
  audioChunks = [];
}

function envoyerPriere() {
  if (audioBlob) cancelAudio();
  const input = document.getElementById("priereInput").value.trim().toLowerCase();

  // Commandes de navigation
  const navCommands = {
    'priere': 'prieres', 'prieres': 'prieres',
    'video': 'videos', 'videos': 'videos',
    'quiz': 'jeux', 'jeu': 'jeux', 'jeux': 'jeux',
    'bible': 'bible',
    'don': 'dons', 'dons': 'dons', 'donner': 'dons',
    'rendez-vous': 'rendez-vous', 'rdv': 'rendez-vous',
    'statistique': 'stats', 'stats': 'stats',
    'favori': 'favorites', 'favoris': 'favorites',
    'note': 'notes', 'notes': 'notes',
    'objectif': 'goals', 'objectifs': 'goals',
    'temoignage': 'testimonies', 't√©moignages': 'testimonies',
    'communaute': 'communaute', 'communaut√©': 'communaute',
    'parametre': 'parametres', 'param√®tres': 'parametres'
  };

  // V√©rifier si c'est une commande de navigation
  for (const [keyword, section] of Object.entries(navCommands)) {
    if (input.includes(keyword)) {
      const userName = currentUser ? currentUser.fullname.split(' ')[0] : 'ami(e)';
      const reponseDiv = document.getElementById("reponse");
      reponseDiv.innerHTML = `
        <p class="compassion">‚ú® ${userName}, je vous guide vers la section demand√©e !</p>
        <p style="background: rgba(255,235,59,0.1); padding: 15px; border-radius: 8px; margin: 15px 0;">
          <strong style="color: #ffeb3b;">üìç Navigation :</strong><br>
          Je vous redirige vers <strong>${keyword}</strong>...
        </p>
        <p class="signature">‚ú® JOHN - Votre guide dans l'application</p>
      `;
      reponseDiv.classList.add("active");
      setTimeout(() => {
        if(['stats','favorites','notes','goals','testimonies'].includes(section)) {
          const actions = {stats: showStats, favorites: showFavorites, notes: showNotes, goals: showGoals, testimonies: showTestimonies};
          actions[section]({preventDefault: ()=>{}});
        } else {
          afficher(section);
        }
      }, 1500);
      document.getElementById("priereInput").value = '';
      return;
    }
  }

  // Aide sur l'application
  if (input.includes('aide') || input.includes('comment') || input.includes('utiliser') || input.includes('fonctionner')) {
    const userName = currentUser ? currentUser.fullname.split(' ')[0] : 'ami(e)';
    const reponseDiv = document.getElementById("reponse");
    reponseDiv.innerHTML = `
      <p class="compassion">üìñ ${userName}, voici comment utiliser l'application :</p>
      <div style="background: rgba(255,235,59,0.1); padding: 15px; border-radius: 8px; margin: 15px 0;">
        <strong style="color: #ffeb3b;">üéØ Sections disponibles :</strong><br>
        ‚Ä¢ <strong>Pri√®res</strong> : 8 cat√©gories de pri√®res quotidiennes<br>
        ‚Ä¢ <strong>Bible</strong> : 3 versions avec audio et mode hors ligne<br>
        ‚Ä¢ <strong>Vid√©os</strong> : Contenus spirituels inspirants<br>
        ‚Ä¢ <strong>Quiz</strong> : 5 niveaux pour tester vos connaissances<br>
        ‚Ä¢ <strong>Dons</strong> : Soutenez l'≈ìuvre (5 m√©thodes)<br>
        ‚Ä¢ <strong>Communaut√©</strong> : Groupes, demandes de pri√®re, √©v√©nements<br>
        ‚Ä¢ <strong>Statistiques</strong> : Suivez votre progression spirituelle
      </div>
      <p><strong>üí° Astuce :</strong> Dites-moi simplement o√π vous voulez aller ! Exemples :<br>
      "Emm√®ne-moi aux pri√®res", "Je veux lire la Bible", "Montre-moi mes statistiques"</p>
      <p class="signature">‚ú® JOHN - Votre guide spirituel et assistant d'application</p>
    `;
    reponseDiv.classList.add("active");
    document.getElementById("priereInput").value = '';
    return;
  }

  const reponses = {
    guerison: [
      "Il a pris nos infirmit√©s, et il s'est charg√© de nos maladies. (Matthieu 8:17)",
      "Mais il √©tait bless√© pour nos p√©ch√©s, bris√© pour nos iniquit√©s; le ch√¢timent qui nous donne la paix est tomb√© sur lui, et c'est par ses meurtrissures que nous sommes gu√©ris. (√âsa√Øe 53:5)",
      "Confie-toi en l'√âternel de tout ton c≈ìur, et ne t'appuie pas sur ta sagesse; reconnais-le dans toutes tes voies, et il aplanira tes sentiers. (Proverbes 3:5-6)"
    ],
    famille: [
      "Moi et ma maison, nous servirons l'√âternel. (Josu√© 24:15)",
      "Crois au Seigneur J√©sus, et tu seras sauv√©, toi et ta famille. (Actes 16:31)",
      "Instruis l'enfant selon la voie qu'il doit suivre; et quand il sera vieux, il ne s'en d√©tournera pas. (Proverbes 22:6)"
    ],
    foi: [
      "Ayant les regards sur J√©sus, le chef et le consommateur de la foi. (H√©breux 12:2)",
      "J√©sus lui dit: Je suis la r√©surrection et la vie. Celui qui croit en moi vivra, quand m√™me il serait mort. (Jean 11:25)",
      "J√©sus lui dit: Si tu peux croire, tout est possible √† celui qui croit. (Marc 9:23)"
    ],
    combat: [
      "Il a d√©pouill√© les dominations et les autorit√©s, et les a livr√©es publiquement en spectacle, en triomphant d'elles par la croix. (Colossiens 2:15)",
      "Rev√™tez-vous de toutes les armes de Dieu, afin de pouvoir tenir ferme contre les ruses du diable. (√âph√©siens 6:11)",
      "Soumettez-vous donc √† Dieu; r√©sistez au diable, et il fuira loin de vous. (Jacques 4:7)"
    ],
    paix: [
      "Car un enfant nous est n√©, un fils nous est donn√©, et on l'appellera... Prince de la paix. (√âsa√Øe 9:6)",
      "Je vous laisse la paix, je vous donne ma paix. Je ne vous donne pas comme le monde donne. (Jean 14:27)",
      "Ne vous inqui√©tez de rien; mais en toute chose faites conna√Ætre vos besoins √† Dieu par des pri√®res et des supplications, avec des actions de gr√¢ces. (Philippiens 4:6)"
    ]
  };

  let theme = "foi";
  if (input.includes("gu√©ri") || input.includes("maladie") || input.includes("sant√©")) theme = "guerison";
  else if (input.includes("famille") || input.includes("enfant") || input.includes("mariage")) theme = "famille";
  else if (input.includes("combat") || input.includes("ennemi") || input.includes("lutte")) theme = "combat";
  else if (input.includes("paix") || input.includes("calme") || input.includes("repos")) theme = "paix";

  const paroles = reponses[theme];
  const parole = paroles[Math.floor(Math.random() * paroles.length)];
  
  const guides = {
    guerison: [
      `Ce verset rappelle que la gu√©rison est possible et que Dieu voit ta douleur. <br>Garde confiance aujourd'hui; fais un petit pas concret vers le soin (repos, m√©decin, pri√®re).`,
      `Ce passage affirme que la souffrance n'est pas ton dernier mot. <br>Porte cette esp√©rance dans ton c≈ìur et accepte l'aide autour de toi.`
    ],
    famille: [
      `Ce verset t'encourage √† placer J√©sus au centre de ta maison. <br>Recherche la paix en pratiquant le pardon et en priant ensemble.`,
      `La parole renforce les liens familiaux lorsqu'on s'appuie sur la foi. <br>Parle avec douceur, aime intentionnellement et demande la b√©n√©diction de Dieu.`
    ],
    foi: [
      `Ce verset te rappelle que la foi soutient les jours difficiles. <br>Tiens-toi ferme dans la pri√®re et avance par petits pas de confiance.`,
      `La foi ouvre des chemins l√† o√π tu vois des barri√®res. <br>Confie tes peurs √† Dieu et agis avec esp√©rance aujourd'hui.`
    ],
    combat: [
      `Ce passage te rappelle que tu n'es pas seul dans la bataille. <br>Rev√™ts-toi de courage, prie pour force, et appuie-toi sur les promesses de Dieu.`,
      `La victoire est d√©j√† proclam√©e par la croix; tiens-toi ferme. <br>Affirme la parole, refuse la peur et cherche le soutien des fr√®res et s≈ìurs.`
    ],
    paix: [
      `Ce verset apporte une paix qui d√©passe la compr√©hension. <br>Respire profond√©ment, confie tes inqui√©tudes √† J√©sus et accueille sa paix.`,
      `La paix est un don; laisse-la habiter ton c≈ìur aujourd'hui. <br>Prends un moment pour te recueillir et permettre √† Dieu de calmer ta temp√™te.`
    ]
  };

  function makeMessage(theme, verse) {
    const arr = guides[theme] || guides['foi'];
    const guide = arr[Math.floor(Math.random() * arr.length)];
    const userName = currentUser ? currentUser.fullname.split(' ')[0] : 'ami(e)';
    return `
      <p class="compassion">üìñ ${userName}, voici ce que la Bible dit sur ta pr√©occupation :</p>
      <p style="background: rgba(255,235,59,0.1); padding: 15px; border-left: 4px solid #ffeb3b; border-radius: 8px; margin: 15px 0;">
        <strong style="color: #ffeb3b;">üìú Verset biblique :</strong><br>
        <em style="font-size: 16px; line-height: 1.8;">${verse}</em>
      </p>
      <p><strong>üí° Application pratique :</strong><br>${guide}</p>
      <p style="margin-top: 15px; padding: 12px; background: rgba(106,17,203,0.2); border-radius: 8px; font-size: 14px;">
        üìñ <strong>JOHN - IA Biblique & Guide</strong> : Je r√©ponds √† vos questions bibliques et je vous guide dans l'application. 
        Dites "aide" pour d√©couvrir toutes les fonctionnalit√©s ou nommez une section pour y acc√©der directement.
      </p>
      <p class="signature">‚ú® JOHN - Agent IA Biblique & Assistant ‚Ä¢ "Ta parole est une lampe √† mes pieds" (Psaume 119:105)</p>
    `;
  }

  if (input) {
    const reponseDiv = document.getElementById("reponse");
    reponseDiv.innerHTML = makeMessage(theme, parole);
    reponseDiv.classList.add("active");
    document.getElementById("priereInput").value = '';
  } else {
    alert("Veuillez entrer une pri√®re.");
  }
}
</script>
